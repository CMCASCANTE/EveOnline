<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}EVE LP Market Analyzer{% endblock %}</title>
    <!-- Carga de Tailwind CSS para estilos de modal y modernización -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Estilo EVE Online (Mantenido y adaptado) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            background-color: #0d1117;
            color: #ffffff;
            font-family: 'Inter', sans-serif; /* Usamos Inter como estándar */
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 95%;
            margin: auto;
        }
        h1, h2 {
            color: #00bfff;
            border-bottom: 2px solid #00bfff;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #30363d;
        }
        .meta-info {
            font-size: 0.8em;
            color: #8b949e;
            margin-bottom: 20px;
        }
        
        /* Estilo de la tabla */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            table-layout: auto;
        }
        .data-table th, .data-table td {
            border: 1px solid #30363d;
            padding: 8px 6px;
            text-align: right;
            white-space: nowrap;
        }
        .data-table th {
            background-color: #161b22;
            color: #ffffff;
            text-align: center;
            font-weight: normal;
        }
        /* Alineación específica de columnas */
        .data-table .item-col {
            text-align: left;
            width: 20%; /* Reducido para hacer espacio al botón IA */
            white-space: normal;
        }
        .data-table .market-col {
            text-align: center;
            width: 8%;
        }
        /* Colores de rentabilidad */
        .positive { color: #00ff00; } 
        .negative { color: #ff0000; } 
        .reload-button {
            background-color: #30363d;
            color: #ffffff;
            border: 1px solid #8b949e;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .reload-button:hover {
            background-color: #40464d;
        }

        /* NUEVOS ESTILOS PARA EL BOTÓN IA */
        .ia-button {
            background-color: #38a169; /* Verde / Ciano para IA */
            color: white;
            border: none;
            padding: 5px 8px;
            font-size: 0.75em;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
            font-weight: bold;
        }
        .ia-button:hover {
            background-color: #2f855a;
        }

        /* ESTILOS DEL MODAL (Aprovechando Tailwind) */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            z-index: 50;
        }
        .modal-content {
            background-color: #161b22;
            border: 1px solid #30363d;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            max-height: 90vh; 
        }
    </style>
</head>
<body>

{% block content %}{% endblock %}

<!-- Modal de Resumen de Pedidos (Hidden by default) -->
<div id="order-summary-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
    <div class="modal-content w-full max-w-2xl mx-auto rounded-xl p-6 relative">
        
        <!-- Encabezado del Modal -->
        <div class="flex justify-between items-center border-b pb-3 mb-4 border-gray-700">
            <h3 id="modal-title" class="text-xl font-bold text-[#00bfff]">Resumen de Pedidos</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-white transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>

        <!-- Cuerpo del Modal -->
        <div class="overflow-y-auto" style="max-height: 70vh;">
            <!-- Indicador de carga -->
            <p id="modal-status" class="text-center text-yellow-400 mb-4 flex items-center justify-center space-x-2 hidden">
                <!-- SVG para el spinner -->
            </p>
            
            <!-- Contenido de la IA -->
            <div id="modal-body" class="text-sm">
                <!-- El resumen generado por Gemini se insertará aquí -->
            </div>
        </div>

        <!-- Pie de Modal -->
        <div class="border-t pt-4 mt-4 border-gray-700 flex justify-end">
             <button 
                onclick="closeModal()" 
                class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-700 hover:bg-gray-600 transition duration-150 text-white"
            >
                Cerrar
            </button>
        </div>
    </div>
</div>


<!-- Lógica JavaScript para ESI y Gemini -->
<script>
    // Configuración inicial de la API Key (debe estar vacía)
    const API_KEY = "";
    const ESI_BASE_URL = 'https://esi.evetech.net/latest';
    const JITA_REGION_ID = 10000002; // The Forge



    // Antigua: function generateOrderSummary(typeId, encodedItemName) { ... }
    // Nueva:
    function handleOrderAnalysis(buttonElement) {
        // 1. Leer los datos del botón
        const typeId = buttonElement.dataset.typeId;
        const itemName = buttonElement.dataset.itemName; // Ya está escapado por Jinja

        // 2. Llamar a la lógica de la API
        generateOrderSummary(typeId, itemName);
    }

    

    /**
     * Función principal: 1. Fetch ESI Orders -> 2. Call Gemini -> 3. Show Modal
     */
    async function generateOrderSummary(itemId, itemName) {
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalStatus = document.getElementById('modal-status');
        const orderSummaryModal = document.getElementById('order-summary-modal');

        // 1. Mostrar Modal y estado de carga
        modalTitle.textContent = `Analizando Pedidos de Venta: ${itemName}`;
        modalBody.innerHTML = '';
        modalStatus.classList.remove('hidden');
        modalStatus.innerHTML = `
            <svg class="animate-spin h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Obteniendo datos ESI (Jita)...</span>
        `;
        orderSummaryModal.classList.remove('hidden');

        let rawOrders;
        try {
            // 2. FETCH DATOS REALES DE EVE ESI (solo Jita, órdenes de venta)
            const esiUrl = `${ESI_BASE_URL}/markets/${JITA_REGION_ID}/orders/?datasource=tranquility&order_type=sell&type_id=${itemId}`;
            const esiResponse = await fetch(esiUrl);
            
            if (!esiResponse.ok) {
                throw new Error(`Error ESI: HTTP ${esiResponse.status}.`);
            }
            rawOrders = await esiResponse.json(); 

        } catch (error) {
            console.error("Error al obtener datos ESI:", error);
            modalStatus.textContent = `Error ESI: ${error.message}. No se pudo obtener la data del mercado.`;
            return;
        }

        // 3. PROCESAMIENTO DE DATOS PARA GEMINI
        if (rawOrders.length === 0) {
             modalBody.innerHTML = `<p class="text-red-400">No se encontraron pedidos de venta activos para ${itemName} en The Forge (Jita).</p>`;
             modalStatus.classList.add('hidden');
             return;
        }

        // Ordenar por precio ascendente (los más baratos, que reflejan la presión de venta)
        rawOrders.sort((a, b) => a.price - b.price);

        const lowestPrice = rawOrders[0].price;
        const totalVolume = rawOrders.reduce((sum, order) => sum + order.volume_remain, 0);

        let promptContext = `ANÁLISIS DE MERCADO: ${itemName}\n\n`;
        promptContext += `Región: The Forge (Jita). Total Pedidos Encontrados: ${rawOrders.length}. Volumen Total Disponible: ${totalVolume.toLocaleString('es-ES')} unidades.\n`;
        promptContext += `Precio Más Bajo Actual: ${lowestPrice.toLocaleString('es-ES', { maximumFractionDigits: 2 })} ISK.\n\n`;
        promptContext += "Los 10 pedidos de venta más baratos (precio, volumen, ID de estación):\n";

        // Listar las primeras 10 órdenes más relevantes
        rawOrders.slice(0, 10).forEach(order => {
            promptContext += `- ${order.price.toLocaleString('es-ES', { maximumFractionDigits: 2 })} ISK | Vol: ${order.volume_remain.toLocaleString('es-ES')} | Estación ID: ${order.location_id}\n`;
        });

        // 4. PREPARAR Y LLAMAR A GEMINI
        modalStatus.innerHTML = `
            <svg class="animate-spin h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Generando resumen analítico con IA...</span>
        `;

        const systemPrompt = "Actúa como un analista de mercado experto de EVE Online. Basado en los datos crudos proporcionados (precios y volúmenes en Jita), genera un resumen conciso (máximo 150 palabras) y una recomendación clara de trading (Comprar ahora/Vender ahora/Esperar). Evalúa la liquidez (volumen total) y la presión de venta (pedidos baratos).";
        const userQuery = `Analiza la siguiente información de pedidos de EVE Online (ya procesada). Genera el resumen y la recomendación. Datos:\n\n${promptContext}`;
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        // 5. LLAMADA A LA API DE GEMINI
        try {
            const response = await callApiWithRetry(apiUrl, payload);
            const text = response.candidates?.[0]?.content?.parts?.[0]?.text || 'Error: La IA no devolvió un resumen.';
                
            // Mostrar el resumen generado
            modalBody.innerHTML = `<p class="text-gray-300 whitespace-pre-line p-4 rounded-lg bg-gray-800 border border-gray-700">${text}</p>`;
            modalStatus.classList.add('hidden');

        } catch (error) {
            console.error("Error al llamar a Gemini:", error);
            modalStatus.textContent = `Error de conexión con la IA. Inténtalo de nuevo.`;
        }
    }

    /**
     * Función auxiliar para simular fetch con reintento (Backoff Exponencial)
     */
    async function callApiWithRetry(url, payload, retries = 3, delay = 1000) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429 && i < retries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                    continue;
                }

                if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();

            } catch (error) {
                if (i === retries - 1) throw error;
            }
        }
    }

    // Función para cerrar el modal
    function closeModal() {
        document.getElementById('order-summary-modal').classList.add('hidden');
    }

</script>

</body>
</html>
