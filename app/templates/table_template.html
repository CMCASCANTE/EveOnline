<table class="data-table {% if market_name %}regional-table{% else %}global-table{% endif %}" id="{{ table_id }}">
    <thead>
        <tr>
            {# Columna ISK/LP AVG (0) es la primera columna para todas las tablas #}
            {% set numeric_cols_lp = [0, 1, 2, 3, 4, 6, 7, 8, 9] %} 
            {% for header in headers %}
                {% if header == 'Mercado' and not market_name %}
                    {% set i = loop.index0 %}
                    <th class="market-col" 
                        onclick="sortTable('{{ table_id }}', {{ i }}, false)"
                    >
                        {{ header }}
                        <span class="sort-indicator" data-col="{{ i }}"></span>
                    </th>
                {% elif header != 'Mercado' %}
                    {# El índice i es el índice real de la columna en la tabla. #}
                    {% set i = loop.index0 - (1 if market_name and loop.index0 > 4 else 0) %}
                    
                    {% set is_numeric = i in numeric_cols_lp %}
                    
                    <th {% if 'Item' in header %}class="item-col"{% endif %}
                        {% if 'ISK' in header or 'Volumen' in header or 'ANÁLISIS' in header %}class="isk-col"{% endif %}
                        onclick="sortTable('{{ table_id }}', {{ i }}, {{ 'true' if is_numeric else 'false' }})"
                    >
                        {{ header }}
                        <span class="sort-indicator" data-col="{{ i }}"></span>
                    </th>
                {% endif %}
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for result in current_results %}
            <tr>
                <td class="isk-col {{ 'positive' if result.isk_per_lp >= 1 else 'negative' }}">
                    {{ "{:,.0f}".format(result.isk_per_lp) }}
                </td>
                <td class="isk-col {{ 'positive' if result.isk_per_lp_current >= 1 else 'negative' }}">
                    {{ "{:,.0f}".format(result.isk_per_lp_current) }}
                </td>
                <td class="{{ 'positive' if result.isk_profit >= 0 else 'negative' }}">
                    {{ "{:,.0f}".format(result.isk_profit) }}
                </td>
                <td>{{ "{:,.0f}".format(result.lp_cost) }}</td>
                <td>{{ "{:,.0f}".format(result.isk_base_cost) }}</td>

                {% if not market_name %}
                    <td class="market-col">{{ result.market }}</td>
                {% endif %}

                <td>{{ "{:,.2f}".format(result.sell_price_avg) }}</td>
                <td>{{ "{:,.2f}".format(result.sell_price_low) }}</td>
                <td>{{ "{:,.2f}".format(result.sell_price_current) }}</td>

                <td>{{ "{:,.0f}".format(result.volume_10d) }}</td>

                <td>
                    <button
                        data-type-id="{{ result.type_id }}"
                        data-item-name="{{ result.item_name | e }}"
                        data-market-name="{{ result.market }}" 
                        onclick="openModal(this)"
                        class="link-esi"
                    >
                        Detalles
                    </button>
                </td>

                <td class="item-col">{{ result.item_name }} ({{ result.quantity }})</td>
            </tr>
        {% endfor %}
    </tbody>
</table>