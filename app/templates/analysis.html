{% extends 'base_layout.html' %} 

{% block title %}Resultados del An√°lisis{% endblock %}

{% block content %}

<style>
    /* Estilos de Botones de Navegaci√≥n */
    .btn-group { margin-bottom: 20px; }
    .btn-group button {
        background-color: #1E90FF; 
        color: white; 
        border: none; 
        padding: 10px 15px; 
        margin: 5px 5px 5px 0; 
        cursor: pointer; 
        border-radius: 4px;
        transition: background-color 0.3s;
    }
    .btn-group button:hover { background-color: #106fbe; }
    .btn-group button.active { background-color: #ffeb3b; color: #0d1117; font-weight: bold; }
    .hidden-table { display: none !important; }
    
    /* Estilos de tabla (Ajustados para el sorting) */
    .data-table th { cursor: pointer; }
    .sort-indicator { margin-left: 5px; color: #8b949e; }
    .sort-indicator.asc:after { content: "‚ñ≤"; }
    .sort-indicator.desc:after { content: "‚ñº"; }
    
    /* Estilos del bot√≥n Detalles/ESI (Modal) */
    .link-esi {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 4px 8px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 12px;
        margin: 2px 1px;
        cursor: pointer;
        border-radius: 4px;
    }
    .link-esi:hover { background-color: #45a049; }
</style>

<div class="container">
    {% if error %}
        <h1 class="negative">‚ùå Error al Ejecutar el An√°lisis:</h1>
        <p class="negative">{{ error }}</p>
    {% else %}
        <h1>‚úÖ AN√ÅLISIS DE RENTABILIDAD LP FINALIZADO</h1>
        <p class="meta-info">Datos actualizados: {{ data.current_time }}</p>

        <div style="margin-bottom: 20px;">
            <a href="{{ url_for('home') }}">
                <button class="reload-button">
                    ‚¨ÖÔ∏è INICIAR NUEVA B√öSQUEDA
                </button>
            </a>
            <a href="{{ url_for('trading_analysis') }}">
                <button class="reload-button" style="background-color: #FFA07A;">
                    üí∞ IR A TRADING PURO
                </button>
            </a>
        </div>
        
        <div class="btn-group">
            <button class="active" onclick="showTable('global_isk')">Rentabilidad M√°xima</button>
            <button onclick="showTable('global_liquidez_media')">Liquidez Media (ISK/LP ‚â• 1,000)</button>
            <button onclick="showTable('global_liquidez_alta')">Liquidez Alta (ISK/LP ‚â• 2,000)</button>
        </div>

        <div id="global_isk_table" class="table-group">
            {% set current_results = data.global_max_isk %}
            {% set headers = data.headers %}
            {% set table_id = 'table-global-max-isk' %}
            <h2>TABLA 5: TOP {{ data.global_max_isk|length }} RENTABILIDAD M√ÅXIMA GLOBAL</h2>
            {% include 'table_template.html' with context %}
        </div>
        
        <div id="global_liquidez_media_table" class="table-group hidden-table">
            {% set current_results = data.global_liquidez_media %}
            {% set headers = data.headers %}
            {% set table_id = 'table-global-liquidez-media' %}
            <h2>TABLA 6: TOP {{ data.global_liquidez_media|length }} LIQUIDEZ MEDIA (ISK/LP AVG ‚â• 1,000)</h2>
            {% include 'table_template.html' with context %}
        </div>

        <div id="global_liquidez_alta_table" class="table-group hidden-table">
            {% set current_results = data.global_liquidez_alta %}
            {% set headers = data.headers %}
            {% set table_id = 'table-global-liquidez-alta' %}
            <h2>TABLA 7: TOP {{ data.global_liquidez_alta|length }} LIQUIDEZ ALTA (ISK/LP AVG ‚â• 2,000)</h2>
            {% include 'table_template.html' with context %}
        </div>

        <h1>üìä An√°lisis por Mercado Regional</h1>

        {% for market_name, results in data.market_results.items() %}
            {% set current_results = results %}
            {% set table_id = 'table-regional-' + market_name | lower %}
            <h2>{{ market_name }} (Top {{ results|length }})</h2>
            {% include 'table_template.html' with context %}
        {% endfor %}

    {% endif %}

    <div style="margin-top: 50px;">
        <a href="{{ url_for('home') }}" class="reload-button">‚¨ÖÔ∏è INICIAR NUEVA B√öSQUEDA</a>
    </div>

</div>

<script>
    /**
     * Alterna la visualizaci√≥n de las tablas globales
     */
    function showTable(tableId) {
        // Ocultar todas las tablas
        const tableGroups = document.querySelectorAll('.table-group');
        tableGroups.forEach(group => group.classList.add('hidden-table'));

        // Mostrar la tabla seleccionada
        const selectedTable = document.getElementById(tableId + '_table');
        if (selectedTable) {
            selectedTable.classList.remove('hidden-table');
        }

        // Actualizar el estado del bot√≥n
        const buttons = document.querySelectorAll('.btn-group button');
        buttons.forEach(button => button.classList.remove('active'));
        
        if (tableId === 'global_isk') {
            buttons[0].classList.add('active');
        } else if (tableId === 'global_liquidez_media') {
            buttons[1].classList.add('active');
        } else if (tableId === 'global_liquidez_alta') {
            buttons[2].classList.add('active');
        }
    }

    /**
     * [MODIFICADO] Funci√≥n para abrir el modal y cargar el resumen de mercado.
     * @param {HTMLElement} buttonElement - El bot√≥n "Detalles" que se hizo clic.
     */
    function openModal(buttonElement) {
        const typeId = buttonElement.getAttribute('data-type-id');
        const itemName = buttonElement.getAttribute('data-item-name');
        // El mercado de origen se a√±ade en table_template.html (para tablas globales) o 
        // se deduce del contexto del bucle (para tablas regionales)
        const marketName = buttonElement.getAttribute('data-market-name') || 
                           // Intentar deducir el mercado de la tabla regional
                           buttonElement.closest('.container').querySelector('h2').innerText.split('(')[0].trim(); 
        
        const modal = document.getElementById('marketModal');
        const modalBody = document.getElementById('modal-body-content');
        modalBody.innerHTML = 'Cargando an√°lisis de mercado...';
        modal.style.display = 'block';

        fetch('{{ url_for("market_summary_api") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                type_id: typeId, 
                item_name: itemName, 
                source_market_name: marketName 
            })
        })
        .then(response => response.json())
        .then(data => {
            modalBody.innerHTML = data.summary_html;
        })
        .catch(error => {
            console.error('Error fetching market summary:', error);
            modalBody.innerHTML = '<p style="color: #ff3333;">Error al cargar el resumen del mercado. Int√©ntalo de nuevo m√°s tarde.</p>';
        });
    }

    function closeModal() {
        document.getElementById('marketModal').style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == document.getElementById('marketModal')) {
            closeModal();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        showTable('global_isk'); 
    });
</script>

{% endblock %}